services:
- docker

env:
  global:
    - IMAGE_NAME="pegasystems/pega-ready"
    - VERSION="2.1.0-${TRAVIS_REPO_SLUG%%/*}-$TRAVIS_BUILD_NUMBER"
    - secure: "grem7MXnd9P5nW3BoWmidPsjs+e+PAE60PdaR3JRC8UMsVLk77T/HOm7wO5AZasizzfZIvp//ILw36oy04KGps6xKaqJPOvItwBgZRiA2jvmhQ25vZbkWgKH39r9fhNjfkcQQi15mv+I57Vo0Cqg1SBpa/9ZZqfx8YDDGqgPFvr1bEt+QvfrgxysvtMZbff5cERjCFsieD5Hd2HkZggwJmkFSMJYmhUKre7DXQE9LIhSrg9sSM///xJc6p26dri8krgbhqD3gfhLVhN3Gaz4vraGrUuv9XcOApcDtCEJnHaK4jBxrprm2C08YHrcuj8hlZqAXoOFsMVjYvRr6bEh4eUUT/eoQohgrYMwmRDYFM+xXZhOXBmwsBQ2SuHX26JgbY92iKYys/qfrXZTsk/g+PEEyhDLLWiIMJzENOrV7FH+xutFLXOoSudaFYqco8Waa6U4NmGMSVAh2NkCVPS6mXplQyxsmwAicaCYb+FrnBm33PTG2hvSp/QEdbWVPvktAB4wc/ieByGyUBJ7MBieFjfwIvxDpC2G5MSLRlbX5SvTm+YAGh+UNlSTohBO8KFq/KVkA2argVTIi4zDcQPf8f4ZBIHtO6WEcfE2Tpj8z3ZVez1TQN39DMIkuTO7lqxPf11tpjxteb+nB81vpNW2LQC+4PoLVflg2lP/Kij34lM="
    - secure: "SR/0DUt6ICZ0ba5UFgOM5gDOO+9UPheGKc3/DpOY4ZleqMngvE8Ve3rJmYcinJIPMSM1Hg0iVEKbT9bKHXCR0QkRi5FoKwz3IL4CL0EbD6tczMc17hID4f1/dxErA8HqwVDhTVHj9x5Lb8NOj8mAXVzetrteN0ROHCwdRK/FxVqrdvtf4EsXsRb83kdzrpIAsHD/2C3T5GLuyTFMKUuxohqhLVu+quXFuEPmYrPHIxhq4rt4BZ7PmHgVAZ5ohwvbNki/JqTX/nBTCF6KQx/YOa0RcuJa4leFroHNh9DcIWPFHKO5kb96V7E0aRTGQ2L8t++MzHX1/goxQTX8fjhi5s13Lytzs8bpfHsn7MQdkurkhQZUxTh8FIav1+3pQL2uHG/mRwBkHB0L4yyjcueXhs5cdDVX3y9Xx8tf3u/gBGJFmq2aRMvLIFIehnlMManwfQOQtI6m9z3q2cVcf4kKzaUoM3h2NB/7yTwx36bAobGpHYil5nLZ+XOcODEZE+uETsia7qo5ZIteTJwy+WTZy4Y30V9tslwypbnpMs6MUkiU+kjc1C0IDVJ6kP2RDsJNxzmGB9bwCjR1YvjWV4MXp6gRFOBFPeVZD0OU+VOef18I79hCQvp3fobojZ3xwjfGCfDhF7WDS/jhpiaqf1e7fLfz5L5meuBfowiew85sttc="

install:
  - docker login -u="$DOCKER_USER" -p="$DOCKER_PASS" || true
  - curl -L https://github.com/arminc/clair-scanner/releases/download/v8/clair-scanner_linux_amd64 > clair-scanner
  - chmod +x clair-scanner
  - sudo mv clair-scanner /usr/local/bin
  - docker run -d --name db arminc/clair-db
  - docker run -p 6060:6060 --link db:postgres -d --name clair arminc/clair-local-scan:v2.0.6
  - curl -LO https://storage.googleapis.com/container-structure-test/latest/container-structure-test-linux-amd64 && chmod +x container-structure-test-linux-amd64 && sudo mv container-structure-test-linux-amd64 /usr/local/bin/container-structure-test
  
script:
  - make test
  - docker images
  - clair-scanner -w tests/cve-scan-whitelist.yaml -c "http://127.0.0.1:6060" --threshold="High" --ip "$(ip -4 addr show docker0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}')" $IMAGE_NAME:latest

before_deploy:
  - docker login -u="$DOCKER_USER" -p="$DOCKER_PASS" 
  - docker tag $IMAGE_NAME:latest $IMAGE_NAME:$VERSION #Tag for current version

deploy:
  provider: script
  script: make push
  on:
    repo: pegasystems/docker-pega-web-ready
    all_branches: true
    condition: $TRAVIS_BRANCH =~ ^(v.+|master)$
